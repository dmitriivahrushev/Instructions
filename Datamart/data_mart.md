**Витрина данных - Datamart**  
Data Mart — это своего рода мини-хранилище данных, которое создано специально для нужд одного отдела или одной задачи внутри большой компании. Например, отдел маркетинга хочет анализировать продажи товаров, а финансовый отдел — доходы и расходы. Для каждого такого случая создаётся своя маленькая база данных, где собраны только нужные именно этому отделу сведения. Это упрощает работу сотрудников и ускоряет получение нужной информации.

---
**Виды витрин**  
Существуют статичные и динамичные витрины данных. Статичные витрины собираются на основе неизменяющихся данных. Такие данные нужно обработать всего лишь один раз, а затем проанализировать. Статичные данные не требуется снова исследовать через какое-то время.  
**Как обновлять витрину**  
Первый метод обновить значения — удалить текущую таблицу с витриной и выполнить ещё раз запрос, который строит эту самую витрину. Способ самый простой, но не самый безопасный: момент, когда вы удалили таблицу, но ещё не успели создать новую, — блокер для пользователей витрины.  
**Самый оптимальный метод** — инкрементальная загрузка.Инкрементальная загрузка — это метод обновления витрины, когда изменяются не все данные, а только те, которые получили новые значения. Этот подход более сложный, чем простой пересчёт всей витрины: процесс разбивается на несколько этапов и создаётся дополнительная таблица. 
Как работать с витриной с помощью CTE 
Общие табличные выражения позволяют строить промежуточные выборки или таблицы и на их основе делать результирующий запрос. Это могут быть и DML- и DDL-запросы, а конструкция будет следующая:

![increment_datamart](/image/increment_datamart.png)  

Существует два основных способа инкрементальной загрузки: 
 - Первый способ предполагает наличие дополнительной таблицы, в которой каждая строчка — время последнего обновления данных в витрине на основе даты их загрузки в DWH.
 - Второй способ подразумевает использование паттерна Transactional Outbox. Работа паттерна выглядит так:

![Transactional Outbox](/image/transactional_outbox.png) 

---
**Обновить витрину можно другим, более комфортным для всех способом:** 

![update_datamart](/image/update_datamart.png)

Преимущество этой схемы — минимизация издержек для потребителей. Переименование таблиц — быстрая операция: данные никуда не перемещаются, изменяется лишь метаинформация о таблице в БД. Потребители могут пользоваться текущей витриной, пока строится новая.
Однако и в этой схеме также есть и недостатки. Полный пересчёт витрины связан в основном с техническими проблемами: 
- Витрина может долго строиться, особенно в крупных компаниях со множеством данных. К моменту перестроения витрины большая часть информации из неё может быть уже неактуальной, потому что данные за это время сильно изменились.
- Чтобы построить большие витрины, требуется много серверных мощностей, и эти ресурсы уже нельзя будет использовать для выполнения пользовательских запросов. Производительность запросов упадёт, и потребители будут недовольны. Или может просто не хватить места в БД, чтобы держать одновременно две версии одних и тех же витрин.
- Как правило, в витрине изменяется меньшая часть данных, а оставшаяся не обновляется. Получается, что ресурсы обработки тратятся впустую на большое количество неизменяемых данных.
